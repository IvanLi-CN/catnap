name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump_level:
        description: Required when ref=main (major|minor|patch)
        required: false
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: catnap
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  path-gate:
    name: Path Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      frontend_changed: ${{ steps.gate.outputs.frontend_changed }}
      backend_changed: ${{ steps.gate.outputs.backend_changed }}
      docker_changed: ${{ steps.gate.outputs.docker_changed }}
      reason: ${{ steps.gate.outputs.reason }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute change signals
        id: gate
        shell: bash
        run: |
          bash ./.github/scripts/ci-path-gate.sh

      - name: Summary
        if: always()
        shell: bash
        run: |
          {
            echo "### CI gating"
            echo "- reason: ${{ steps.gate.outputs.reason }}"
            echo "- frontend_changed: ${{ steps.gate.outputs.frontend_changed }}"
            echo "- backend_changed: ${{ steps.gate.outputs.backend_changed }}"
            echo "- docker_changed: ${{ steps.gate.outputs.docker_changed }}"
          } >> "${GITHUB_STEP_SUMMARY}"

  label-gate:
    name: PR Label Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      intent_label: ${{ steps.gate.outputs.intent_label }}
      should_release: ${{ steps.gate.outputs.should_release }}
      bump_level: ${{ steps.gate.outputs.bump_level }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate PR intent label
        id: gate
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          bash ./.github/scripts/label-gate.sh

  lint:
    name: Lint & Checks
    runs-on: ubuntu-latest
    needs: [path-gate]
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Bun (optional)
        if: hashFiles('web/package.json') != ''
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1

      - name: Cache Bun install cache (optional)
        if: hashFiles('web/package.json') != ''
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('web/bun.lock*') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Build web dist (optional, required for Rust embed)
        if: hashFiles('web/package.json') != ''
        shell: bash
        run: |
          set -euo pipefail
          cd web
          bun install --frozen-lockfile
          VITE_APP_VERSION="0.0.0" bun run build

      - name: Cache Playwright browsers (gated)
        if: hashFiles('web/package.json') != '' && needs.path-gate.outputs.frontend_changed == 'true'
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('web/bun.lock*') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Front-end heavy checks (gated)
        if: hashFiles('web/package.json') != '' && needs.path-gate.outputs.frontend_changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd web
          bun run lint
          bun run typecheck
          bun run build-storybook
          bunx playwright install-deps chromium
          if [[ "${{ steps.cache-playwright.outputs.cache-hit }}" != "true" ]]; then
            bunx playwright install chromium
          fi
          bun run test:storybook

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install Rust components
        run: rustup component add rustfmt clippy

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cargo fmt check
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Cargo check
        run: cargo check --locked --all-targets --all-features

  unit-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Bun (optional)
        if: hashFiles('web/package.json') != ''
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1

      - name: Cache Bun install cache (optional)
        if: hashFiles('web/package.json') != ''
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('web/bun.lock*') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Build web dist (optional, for embedded UI)
        if: hashFiles('web/package.json') != ''
        shell: bash
        run: |
          set -euo pipefail
          cd web
          bun install --frozen-lockfile
          VITE_APP_VERSION="0.0.0" bun run build

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run cargo test
        run: cargo test --locked --all-features

  pr-release-check:
    name: Release Chain Smoke (PR)
    runs-on: ubuntu-latest
    needs: [path-gate, lint, unit-tests]
    if: |
      github.event_name == 'pull_request' &&
      (needs.path-gate.outputs.frontend_changed == 'true' ||
       needs.path-gate.outputs.backend_changed == 'true' ||
       needs.path-gate.outputs.docker_changed == 'true')
    timeout-minutes: 45
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Mark job start
        id: job-start
        shell: bash
        run: |
          echo "ts=$(date +%s)" >> "${GITHUB_OUTPUT}"

      - name: Set up Bun (optional)
        if: hashFiles('web/package.json') != ''
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1

      - name: Cache Bun install cache (optional)
        id: cache-bun
        if: hashFiles('web/package.json') != ''
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('web/bun.lock*') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Build web dist (optional, for embedded UI)
        if: hashFiles('web/package.json') != ''
        shell: bash
        run: |
          set -euo pipefail
          cd web
          bun install --frozen-lockfile
          VITE_APP_VERSION="0.0.0" bun run build

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Compute effective version
        id: compute-version
        shell: bash
        env:
          BUMP_LEVEL: patch
        run: |
          set -euo pipefail
          start="$(date +%s)"
          bash ./.github/scripts/compute-version.sh
          echo "duration_sec=$(( $(date +%s) - start ))" >> "${GITHUB_OUTPUT}"

      - name: Build backend (release)
        id: build-backend
        shell: bash
        run: |
          set -euo pipefail
          start="$(date +%s)"
          cargo build --release --locked
          echo "duration_sec=$(( $(date +%s) - start ))" >> "${GITHUB_OUTPUT}"

      - name: Smoke test (binary)
        id: smoke-binary
        shell: bash
        run: |
          set -euo pipefail
          start="$(date +%s)"
          bash ./.github/scripts/smoke-test.sh ./target/release/catnap
          echo "duration_sec=$(( $(date +%s) - start ))" >> "${GITHUB_OUTPUT}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Mark Docker build start
        id: docker-build-start
        shell: bash
        run: |
          echo "ts=$(date +%s)" >> "${GITHUB_OUTPUT}"

      - name: Docker build (no push, GHA cache best-effort)
        id: docker-build
        uses: docker/build-push-action@v6
        continue-on-error: true
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          tags: catnap:pr-${{ github.sha }}
          build-args: |
            APP_EFFECTIVE_VERSION=${{ env.APP_EFFECTIVE_VERSION }}
          labels: |
            org.opencontainers.image.version=${{ env.APP_EFFECTIVE_VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Record Docker build timing
        id: docker-build-timing
        if: always()
        shell: bash
        run: |
          start="${{ steps.docker-build-start.outputs.ts }}"
          if [[ -z "${start}" ]]; then
            echo "WARN: missing docker build start timestamp; skipping timing." >&2
            echo "duration_sec=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          echo "duration_sec=$(( $(date +%s) - start ))" >> "${GITHUB_OUTPUT}"

      - name: Warn on Docker cache export failure (retrying without cache-to)
        if: steps.docker-build.outcome == 'failure'
        shell: bash
        run: |
          echo "WARN: Docker build step failed with GHA cache enabled; retrying without cache-to. If the retry succeeds, this is treated as a cache export/transient issue; real build errors must still fail the job." >&2

      - name: Mark Docker build start (fallback)
        id: docker-build-fallback-start
        if: steps.docker-build.outcome == 'failure'
        shell: bash
        run: |
          echo "ts=$(date +%s)" >> "${GITHUB_OUTPUT}"

      - name: Docker build (no push, fallback without cache-to)
        if: steps.docker-build.outcome == 'failure'
        id: docker-build-fallback
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          tags: catnap:pr-${{ github.sha }}
          build-args: |
            APP_EFFECTIVE_VERSION=${{ env.APP_EFFECTIVE_VERSION }}
          labels: |
            org.opencontainers.image.version=${{ env.APP_EFFECTIVE_VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
          cache-from: type=gha

      - name: Record Docker build timing (fallback)
        id: docker-build-fallback-timing
        if: steps.docker-build.outcome == 'failure' && always()
        shell: bash
        run: |
          start="${{ steps.docker-build-fallback-start.outputs.ts }}"
          if [[ -z "${start}" ]]; then
            echo "WARN: missing docker build fallback start timestamp; skipping timing." >&2
            echo "duration_sec=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          echo "duration_sec=$(( $(date +%s) - start ))" >> "${GITHUB_OUTPUT}"

      - name: Summary (timings)
        if: always()
        shell: bash
        run: |
          fmt_sec() {
            local v="$1"
            if [[ -z "${v}" ]]; then
              echo "n/a"
            else
              echo "${v}s"
            fi
          }

          start_ts="${{ steps.job-start.outputs.ts }}"
          if [[ -z "${start_ts}" ]]; then
            total="n/a"
          else
            total="$(fmt_sec "$(( $(date +%s) - start_ts ))")"
          fi

          docker_fallback_status="${{ steps.docker-build-fallback.conclusion || 'skipped' }}"
          {
            echo "### PR release chain timings"
            echo "- total: ${total}"
            echo "- reason: ${{ needs.path-gate.outputs.reason }}"
            echo "- effective_version: ${{ env.APP_EFFECTIVE_VERSION }}"
            echo "- bun_cache_hit: ${{ steps.cache-bun.outputs.cache-hit || 'n/a' }}"
            echo "- compute_version: $(fmt_sec '${{ steps.compute-version.outputs.duration_sec }}')"
            echo "- cargo_build_release: $(fmt_sec '${{ steps.build-backend.outputs.duration_sec }}')"
            echo "- smoke_test: $(fmt_sec '${{ steps.smoke-binary.outputs.duration_sec }}')"
            echo "- docker_build_primary(outcome=${{ steps.docker-build.outcome }}): $(fmt_sec '${{ steps.docker-build-timing.outputs.duration_sec }}')"
            echo "- docker_build_fallback(conclusion=${docker_fallback_status}): $(fmt_sec '${{ steps.docker-build-fallback-timing.outputs.duration_sec }}')"
          } >> "${GITHUB_STEP_SUMMARY}"

  release-intent:
    name: Release Intent (gate)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      should_release: ${{ steps.intent.outputs.should_release }}
      bump_level: ${{ steps.intent.outputs.bump_level }}
      intent_label: ${{ steps.intent.outputs.intent_label }}
      pr_number: ${{ steps.intent.outputs.pr_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine release intent
        id: intent
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUMP_LEVEL: ${{ github.event.inputs.bump_level }}
        run: |
          bash ./.github/scripts/release-intent.sh

  release:
    name: Release (tag/assets/image)
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && needs.release-intent.outputs.should_release == 'true'
    needs: [lint, unit-tests, release-intent]
    timeout-minutes: 90
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine release version/tag
        id: release-meta
        shell: bash
        run: |
          set -euo pipefail

          ref="${GITHUB_REF}"
          ref_name="${GITHUB_REF_NAME}"

          echo "release intent: pr=${{ needs.release-intent.outputs.pr_number }} label=${{ needs.release-intent.outputs.intent_label }} bump_level=${{ needs.release-intent.outputs.bump_level }}"

          if [[ "${ref}" == refs/tags/* ]]; then
            tag="${ref_name}"
            if [[ "${tag}" != v* ]]; then
              echo "tag must start with 'v': ${tag}" >&2
              exit 1
            fi
            version="${tag#v}"
            is_main="false"
            echo "release ref: tag ${tag}"
          else
            if [[ "${ref}" != "refs/heads/main" ]]; then
              echo "unsupported ref for release: ${ref}" >&2
              exit 1
            fi

            is_main="true"
            existing_tag="$(git tag --points-at HEAD | grep -E '^v[0-9]+\\.[0-9]+\\.[0-9]+$' | head -n1 || true)"
            if [[ -n "${existing_tag}" ]]; then
              tag="${existing_tag}"
              version="${tag#v}"
              echo "reuse existing tag: ${tag}"
            else
              export BUMP_LEVEL="${{ needs.release-intent.outputs.bump_level }}"
              source ./.github/scripts/compute-version.sh
              version="${APP_EFFECTIVE_VERSION}"
              tag="v${version}"
              echo "computed version: ${version}"
            fi
          fi

          echo "APP_EFFECTIVE_VERSION=${version}" >> "${GITHUB_ENV}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "is_main=${is_main}" >> "${GITHUB_OUTPUT}"

      - name: Create and push tag (main only, if missing)
        if: steps.release-meta.outputs.is_main == 'true'
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.release-meta.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
            echo "tag exists: ${tag}"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "${tag}" -m "${tag}"
          git push origin "${tag}"

      - name: Set up Bun (optional)
        if: hashFiles('web/package.json') != ''
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1

      - name: Build web (optional, for embedded UI)
        if: hashFiles('web/package.json') != ''
        shell: bash
        run: |
          set -euo pipefail
          cd web
          bun install --frozen-lockfile
          VITE_APP_VERSION="${APP_EFFECTIVE_VERSION}" bun run build

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build release assets (linux/amd64+arm64, gnu+musl)
        shell: bash
        run: |
          set -euo pipefail

          cargo install cross --locked

          out_dir="dist/release-assets"
          rm -rf "${out_dir}"
          mkdir -p "${out_dir}"

          build_one() {
            local target="$1"
            local arch="$2"
            local abi="$3"

            cross build --release --locked --target "${target}"

            local bin="target/${target}/release/catnap"
            if [[ ! -f "${bin}" ]]; then
              echo "missing binary: ${bin}" >&2
              exit 1
            fi

            local base="catnap_${APP_EFFECTIVE_VERSION}_linux_${arch}_${abi}"
            local tgz="${out_dir}/${base}.tar.gz"
            tar -C "$(dirname "${bin}")" -czf "${tgz}" catnap
            sha256sum "${tgz}" | awk '{print $1}' > "${tgz}.sha256"
          }

          build_one x86_64-unknown-linux-gnu amd64 gnu
          build_one aarch64-unknown-linux-gnu arm64 gnu
          build_one x86_64-unknown-linux-musl amd64 musl
          build_one aarch64-unknown-linux-musl arm64 musl

      - name: Smoke test (linux/amd64 gnu binary)
        shell: bash
        run: |
          bash ./.github/scripts/smoke-test.sh ./target/x86_64-unknown-linux-gnu/release/catnap

      - name: Create/Update GitHub Release and upload assets
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.release-meta.outputs.tag }}
          name: ${{ steps.release-meta.outputs.tag }}
          generateReleaseNotes: true
          allowUpdates: true
          omitBodyDuringUpdate: true
          artifacts: dist/release-assets/*
          artifactErrorsFailBuild: true
          replacesArtifacts: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tags
        id: image-tags
        shell: bash
        run: |
          set -euo pipefail

          owner_lower="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          image="${REGISTRY}/${owner_lower}/${IMAGE_REPO}"

          {
            echo "image=${image}"
            echo "tags<<EOF"
            echo "${image}:v${APP_EFFECTIVE_VERSION}"
            if [[ "${{ steps.release-meta.outputs.is_main }}" == "true" ]]; then
              echo "${image}:latest"
            fi
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Build and push Docker image
        id: docker-push
        uses: docker/build-push-action@v6
        continue-on-error: true
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.image-tags.outputs.tags }}
          labels: |
            org.opencontainers.image.version=${{ env.APP_EFFECTIVE_VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
          build-args: |
            APP_EFFECTIVE_VERSION=${{ env.APP_EFFECTIVE_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Warn on Docker cache export failure (retrying without cache-to)
        if: steps.docker-push.outcome == 'failure'
        shell: bash
        run: |
          echo "WARN: Docker push step failed with GHA cache enabled; retrying without cache-to. If the retry succeeds, this is treated as a cache export/transient issue; real build errors must still fail the job." >&2

      - name: Build and push Docker image (fallback without cache-to)
        if: steps.docker-push.outcome == 'failure'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.image-tags.outputs.tags }}
          labels: |
            org.opencontainers.image.version=${{ env.APP_EFFECTIVE_VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
          build-args: |
            APP_EFFECTIVE_VERSION=${{ env.APP_EFFECTIVE_VERSION }}
          cache-from: type=gha
